# Makefile para facilitar comandos Docker
# Sistema de Detec√ß√£o de Objetos - InovaTech 2025

.PHONY: help build up down restart logs ps clean test health shell

# Vari√°veis
COMPOSE = docker-compose
SERVICE = vision-streaming
SERVICE_BASIC = vision-basic

help: ## Mostrar esta ajuda
	@echo "üìã Comandos dispon√≠veis:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

build: ## Construir imagem Docker
	@echo "üî® Construindo imagem..."
	$(COMPOSE) build

up: ## Iniciar servidor principal (vision-streaming)
	@echo "üöÄ Iniciando vision-streaming..."
	$(COMPOSE) up -d $(SERVICE)
	@echo "‚úÖ Servidor rodando em http://localhost:3000"
	@echo "üìö Swagger: http://localhost:3000/api/docs"
	@echo "üì° SSE: http://localhost:3000/api/stream/events"

up-all: ## Iniciar todos os servidores (streaming + basic)
	@echo "üöÄ Iniciando todos os servidores..."
	$(COMPOSE) --profile full up -d
	@echo "‚úÖ vision-streaming: http://localhost:3000"
	@echo "‚úÖ vision-basic: http://localhost:3001"

down: ## Parar e remover containers
	@echo "üõë Parando containers..."
	$(COMPOSE) down

stop: ## Parar containers (sem remover)
	@echo "‚è∏Ô∏è  Parando containers..."
	$(COMPOSE) stop

start: ## Iniciar containers existentes
	@echo "‚ñ∂Ô∏è  Iniciando containers..."
	$(COMPOSE) start

restart: ## Reiniciar containers
	@echo "üîÑ Reiniciando containers..."
	$(COMPOSE) restart $(SERVICE)

rebuild: ## Reconstruir e reiniciar
	@echo "üî® Reconstruindo..."
	$(COMPOSE) build --no-cache
	@echo "üöÄ Reiniciando..."
	$(COMPOSE) up -d $(SERVICE)

logs: ## Ver logs (Ctrl+C para sair)
	@echo "üìú Logs do vision-streaming:"
	$(COMPOSE) logs -f $(SERVICE)

logs-all: ## Ver logs de todos os servidores
	@echo "üìú Logs de todos os servidores:"
	$(COMPOSE) logs -f

logs-basic: ## Ver logs do vision-basic
	@echo "üìú Logs do vision-basic:"
	$(COMPOSE) logs -f $(SERVICE_BASIC)

ps: ## Ver status dos containers
	@echo "üìä Status dos containers:"
	$(COMPOSE) ps

stats: ## Ver uso de CPU/RAM
	@echo "üìà Uso de recursos:"
	docker stats vision-streaming

health: ## Verificar sa√∫de do servidor
	@echo "üè• Verificando sa√∫de..."
	@curl -s http://localhost:3000/health && echo "" || echo "‚ùå Servidor n√£o respondeu"
	@echo ""
	@echo "üìä Status completo:"
	@curl -s http://localhost:3000/api/system/status | jq '.' 2>/dev/null || curl -s http://localhost:3000/api/system/status

test: ## Testar endpoints principais
	@echo "üß™ Testando endpoints..."
	@echo ""
	@echo "1Ô∏è‚É£ Health:"
	@curl -s http://localhost:3000/health && echo "" || echo "‚ùå Falhou"
	@echo ""
	@echo "2Ô∏è‚É£ ESP32-CAM:"
	@curl -s http://localhost:3000/api/esp32/test | jq '.status' 2>/dev/null || echo "‚ö†Ô∏è  N√£o conectado"
	@echo ""
	@echo "3Ô∏è‚É£ Detec√ß√µes atuais:"
	@curl -s http://localhost:3000/api/detections/current | jq '.count' 2>/dev/null || echo "‚ö†Ô∏è  Erro"
	@echo ""

test-sse: ## Testar SSE (Ctrl+C para sair)
	@echo "üì° Conectando ao SSE..."
	@echo "Aguardando eventos..."
	curl -N http://localhost:3000/api/stream/events

shell: ## Abrir bash no container
	@echo "üêö Abrindo shell no container..."
	docker exec -it vision-streaming bash

node: ## Abrir Node REPL no container
	@echo "üìù Abrindo Node REPL..."
	docker exec -it vision-streaming node

clean: ## Remover containers, imagens e volumes
	@echo "üßπ Limpando..."
	$(COMPOSE) down -v
	docker image prune -f

clean-all: ## Limpeza completa (CUIDADO!)
	@echo "‚ö†Ô∏è  LIMPEZA COMPLETA - Removendo TUDO..."
	@read -p "Tem certeza? [y/N] " -n 1 -r; \
	echo ""; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		$(COMPOSE) down -v; \
		docker system prune -af --volumes; \
		echo "‚úÖ Limpeza completa realizada"; \
	else \
		echo "‚ùå Cancelado"; \
	fi

swagger: ## Abrir Swagger UI no navegador
	@echo "üìö Abrindo Swagger UI..."
	xdg-open http://localhost:3000/api/docs 2>/dev/null || open http://localhost:3000/api/docs 2>/dev/null || echo "Abra: http://localhost:3000/api/docs"

viewer: ## Abrir interface HTML
	@echo "üñ•Ô∏è  Abrindo viewer..."
	xdg-open http://localhost:3000/viewer.html 2>/dev/null || open http://localhost:3000/viewer.html 2>/dev/null || echo "Abra: http://localhost:3000/viewer.html"

sse-html: ## Abrir teste SSE HTML
	@echo "üì° Abrindo teste SSE..."
	xdg-open http://localhost:3000/test-sse.html 2>/dev/null || open http://localhost:3000/test-sse.html 2>/dev/null || echo "Abra: http://localhost:3000/test-sse.html"

backup-logs: ## Fazer backup dos logs
	@echo "üíæ Fazendo backup dos logs..."
	@mkdir -p backups
	$(COMPOSE) logs --no-color > backups/logs-$(shell date +%Y%m%d-%H%M%S).log
	@echo "‚úÖ Backup salvo em backups/"

install-docker: ## Instalar Docker e Docker Compose (Ubuntu)
	@echo "üì¶ Instalando Docker..."
	sudo apt update
	sudo apt install -y docker.io docker-compose
	sudo usermod -aG docker $$USER
	@echo "‚úÖ Docker instalado!"
	@echo "‚ö†Ô∏è  Fa√ßa logout e login novamente para usar Docker sem sudo"

update: ## Atualizar c√≥digo e reiniciar
	@echo "üîÑ Atualizando..."
	git pull
	$(COMPOSE) build
	$(COMPOSE) up -d $(SERVICE)
	@echo "‚úÖ Atualizado!"

# Atalhos r√°pidos
start-streaming: up ## Alias para 'up'
start-all: up-all ## Alias para 'up-all'
l: logs ## Atalho para logs
h: health ## Atalho para health
s: shell ## Atalho para shell

# Default
.DEFAULT_GOAL := help
